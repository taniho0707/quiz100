# シーケンス負荷テスト

このテストは、クイズアプリケーションの実際の使用シーケンスを模擬した負荷テストです。

## 概要

- **ユーザー数**: 80人
- **接続時間**: 30秒間で段階的に接続
- **制御方法**: 人間がエンターキーでイベントを制御
- **検証内容**: 想定獲得点数と実際の点数の一致を確認

## 回答パターン

各ユーザーには以下のいずれかの回答パターンが割り当てられます：

1. **all_correct**: 全問正解するユーザー
2. **all_wrong**: 全問不正解するユーザー
3. **only_q1**: 1問目だけ正解するユーザー
4. **only_q2**: 2問目だけ正解するユーザー
5. **only_q3**: 3問目だけ正解するユーザー
6. **only_q4**: 4問目だけ正解するユーザー
7. **only_q5**: 5問目だけ正解するユーザー
8. **answer_only_first**: 1問目だけ回答して以降は回答しないユーザー
9. **skip_first**: 1問目をスキップして2問目以降正解するユーザー
10. **change_answer**: 一度違う選択肢を選んでから1秒後に正しい選択肢に変更するユーザー
11. **random**: ランダムに回答するユーザー

## 実行方法

### 1. 依存関係のインストール

```bash
cd scripts/sequence-load-test
go mod download
```

### 2. サーバーの起動

別のターミナルでクイズサーバーを起動してください：

```bash
cd /mnt/s/git/quiz100
go run main.go
```

### 3. テストの実行

```bash
go run main.go
```

## テストシーケンス

テストは以下のシーケンスで進行します：

### Phase 1: ユーザー接続
1. 80人のユーザーが30秒間で段階的に接続
2. 各ユーザーにセッションIDが割り当てられる
3. WebSocket接続が確立される

**操作**: ユーザー接続完了後、エンターキーを押してイベントを開始

### Phase 2: クイズシーケンス（各問題で繰り返し）

各問題で以下の手順を実行：

1. **問題出題**
   - 操作: 管理者画面で「次の問題」をクリック
   - エンターキーを押して進む

2. **回答送信**
   - 自動的に10秒間で分散して回答を送信
   - 一部のユーザーは回答を変更（最初に不正解、1秒後に正解）
   - パターンに応じて回答しないユーザーもいる

3. **回答受付終了**
   - 操作: 管理者画面で「残り5秒アラート」→「回答状況表示」→「回答発表」
   - エンターキーを押して進む

4. **リアクション送信**
   - 自動的に30-50人のユーザーがランダムに絵文字リアクションを送信

5. **次の問題へ**
   - エンターキーを押して次の問題に進む

### Phase 3: 結果確認

1. 全問題完了後、エンターキーを押す
2. 操作: 管理者画面で「結果発表」をクリック
3. 各ユーザーの想定獲得点数と実際の点数を比較
4. 結果レポートを表示

### Phase 4: クリーンアップ

全WebSocket接続を閉じてテスト終了

## 期待される動作

### 正常系
- 全ユーザーが正常に接続できる
- 各ユーザーがパターン通りに回答する
- 最終スコアが期待値と一致する

### 確認項目
- ✅ 一致率: 100%が理想
- ❌ 不一致: 0人が理想
- ⚠️ データなし: 0人が理想

## 結果レポートの見方

```
===========================================
🎯 結果検証レポート
===========================================
✅ 一致: 75人 (93.8%)
❌ 不一致: 3人 (3.8%)
⚠️  データなし: 2人 (2.5%)

不一致・データなしの詳細:
  User015: 期待 13点 → 実際 12点
  User042: 期待 0点 → 実際 1点
  User067: データなし (期待: 13点)
  User078: データなし (期待: 1点)
  User080: 期待 12点 → 実際 11点
===========================================
```

## トラブルシューティング

### 接続エラーが発生する場合
- サーバーが起動しているか確認
- ポート8080が使用可能か確認

### スコアが一致しない場合
- サーバー側の採点ロジックを確認
- WebSocket通信が正常か確認
- データベースの状態を確認

### テストが途中で止まる場合
- エンターキーを押すタイミングを確認
- サーバーログでエラーがないか確認

## カスタマイズ

### ユーザー数の変更
```go
const TotalUsers = 80  // この値を変更
```

### 問題数の変更
```go
const TotalQuestions = 14  // この値を変更

// generateQuestions() 関数内の問題データも更新
```

### 問題の正解・配点の変更
```go
func generateQuestions() []Question {
    questions := []Question{
        {Number: 1, Correct: 1, Point: 0},  // Correct: 正解の選択肢（1-4）, Point: 配点
        // ...
    }
    return questions
}
```

## 注意事項

- テスト実行前にデータベースをバックアップしてください
- 本番環境では実行しないでください
- テスト完了後、必要に応じてデータベースをクリーンアップしてください
