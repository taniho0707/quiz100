# CLAUDE - 宴会クイズサービス要件定義書

## 1. プロジェクト概要

大人数での宴会で使用するリアルタイムクイズシステム。単一サーバーで管理者とユーザーが同時にアクセスし、WebSocketを通じてリアルタイムでクイズイベントを進行する。

## 2. システム構成

### 2.1 技術スタック
- **バックエンド**: Go言語
- **データベース**: SQLite
- **フロントエンド**: HTML/CSS/JavaScript（静的配信）
- **リアルタイム通信**: WebSocket
- **設定ファイル**: TOML形式

### 2.2 アーキテクチャ
```
[管理PC] ──┐
           ├── HTTP/WebSocket ──[Goサーバー]── SQLite
[スマホ] ──┘                     │
                                静的ファイル配信
```

## 3. 機能要件

### 3.1 基本機能

#### 3.1.1 クイズ管理
- TOML設定ファイルからクイズデータを読み込み
- 同時実行可能なクイズイベントは1つのみ
- 選択式問題のみサポート
- 正答は設定ファイルに事前定義し、自動採点

#### 3.1.2 管理機能
- 管理者専用ページからのクイズイベント制御
- イベントの開始/停止/問題遷移操作
- 参加者状況のリアルタイム監視
- 結果表示とログ出力
- 管理者用ページにアクセスできるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)
- 同様に管理者用APIを叩けるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)

#### 3.1.3 参加者機能
- スマートフォンブラウザからの参加
- ニックネーム登録
- Cookieによるセッション管理 (一度切断されても同じユーザーで再接続可能)
- セッション破棄機能（確認ダイアログ付き、誤操作防止UI）
- 問題表示と回答選択
- リアルタイム結果表示
- 絵文字ボタンがあり、押すとスクリーン表示用画面に表示される

#### 3.1.4 スクリーン表示用画面
- 参加者全員が見えるディスプレイに表示することを目的としたページ
- 現在の問題、選択肢、ステータス (何問目、回答受付中かどうか)、絵文字リアクションなどが表示される
- 最終結果や、チーム分けの結果もこの画面に表示される
- スクリーン表示用ページにアクセスできるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)
- 同様にスクリーン表示用APIを叩けるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)

### 3.2 チーム戦モード（オプション）

#### 3.2.1 チーム分け機能
- 設定ファイルでチーム戦モード有効化
- 同グループ回避名称リストの事前設定
- 名称マッチングによる同チーム配置回避アルゴリズム
- 全参加者エントリー完了後の自動チーム分け実行

#### 3.2.2 チーム戦進行
- チーム単位での得点管理
- チーム結果の表示

## 4. 設定ファイル仕様

### 4.1 TOML設定ファイル構造
```toml
[event]
title = "新年会クイズ大会"
team_mode = true
team_size = 5 #チームの最大人数

[team_separation]
avoid_groups = ["田中", "山田", "やまだ", "ヤマダ"]

[[questions]]
type = "text"
text = "Goの作者は誰ですか？"
image = "go_auther.png"
choices = ["Rob Pike", "Linus Torvalds", "Dennis Ritchie", "Ken Thompson"]
correct = 0

[[questions]]
type = "text"
text = "HTTPSのデフォルトポートは？"
choices = ["80", "443", "8080", "3000"]
correct = 1

[[questions]]
type = "image"
text = "IEEEのロゴマークは？"
choices = ["wrong_logo.png", "ieee_logo.png", "bad_logo.png"]
correct = 1
```

## 5. 非機能要件

### 5.1 性能要件
- **同時接続数**: 最大100人
- **応答時間**: WebSocket通信での即座な状態更新
- **可用性**: イベント中の安定した接続維持

### 5.2 運用要件
- **ログ出力**: イベント進行ログをテキストファイルに記録
- **データ保持**: イベント終了後のデータベース保持（履歴機能は不要）
- **設定変更**: サーバー再起動による設定ファイル再読み込み

## 6. システムフロー

### 6.1 個人戦モードフロー
1. 管理者がクイズイベント開始
2. 参加者がニックネーム登録
3. 管理者が問題を順次出題
4. 参加者が制限時間内に回答
5. リアルタイムで結果表示
6. 最終順位発表

### 6.2 チーム戦モードフロー
1. 管理者がチーム戦イベント開始
2. 参加者がニックネーム登録
3. 全員エントリー完了後、自動チーム分け実行
4. チーム発表
5. 管理者が問題を順次出題
6. 参加者が個別に回答（チーム得点に反映）
7. チーム順位発表

## 7. API設計

### 7.1 HTTP エンドポイント
- `GET /` - 参加者用ページ
- `POST /api/join` - 参加者登録
- `POST /api/answer` - 回答送信
- `POST /api/reset-session` - セッション破棄
- `GET /admin` - 管理者用ページ
- `POST /api/admin/start` - イベント開始
- `POST /api/admin/next` - 次の問題へ
- `POST /api/admin/stop` - イベント終了
- `GET /show` - スクリーン表示用画面ページ

### 7.2 WebSocket メッセージ
- `user_joined` - 参加者参加通知
- `user_left` - 参加者離脱通知（セッション破棄時）
- `question_start` - 問題開始
- `question_end` - 回答締切
- `results` - 結果表示
- `team_assignment` - チーム分け結果
- `final_results` - 最終結果
- `emoji` - 絵文字リアクション

## 8. データベース設計

### 8.1 テーブル構成
- **users** - 参加者情報
- **teams** - チーム情報（チーム戦時）
- **answers** - 回答履歴
- **events** - イベント情報

## 9. セキュリティ要件

- 参加者の重複参加防止
- 不正回答の防止（問題IDと回答タイムスタンプの検証）

## 10. 制約事項

- 単一サーバー・単一イベント制限
- ネットワーク環境に依存するリアルタイム性
- ブラウザ互換性（主要モバイルブラウザ対応）

# 🆕 最新実装機能

## イベント状態管理システム ✅ 実装完了（2025/9/2）

### 機能概要
管理者が段階的にクイズ進行を制御できる新しいシステムを実装。従来の単純なボタンから、状態遷移に基づく詳細な制御フローに変更。要求仕様の完全な状態遷移フローを実現。

### 実装詳細

#### 状態遷移フロー（完全実装）
```
(参加者待ち) → イベント開始 → (タイトル表示) → チーム分け → (チーム分け画面)
→ 次の問題 → (問題表示画面) → 残り5秒アラート → (5秒カウントダウン)
→ (回答受付終了と表示) → 回答状況表示 → 回答発表 → (回答が表示される)
→ 次の問題 → ... → 結果発表 → (結果発表と表示) → 発表 
→ (順位表示 + クラッカーアニメーション) → 自動終了
```

#### バックエンド
- **models/models.go**: `EventStateManager`クラス追加
  - 11種類の状態定義（waiting, started, title_display等）
  - 状態遷移の妥当性チェック機能
  - 利用可能なアクションの自動判定
  - チーム戦/個人戦に応じた分岐制御

- **handlers/handlers.go**: 統一的なaction実行システム
  - `/api/admin/action` エンドポイント: 状態ベースのアクション実行
  - `/api/admin/actions` エンドポイント: 利用可能アクション取得
  - 9つのactionハンドラー（start_event, show_title, assign_teams等）
  - 自動状態遷移ロジック（カウントダウン→回答状況、発表→終了）
  - 重複状態遷移エラーの回避処理

#### フロントエンド（管理者画面）
- **admin.html**: 9つの制御ボタンを追加
  - 「タイトル表示」「チーム分け」「📊 回答状況表示」「✅ 回答発表」「🏆 結果発表」「🎉 発表」
  - 状態に応じたボタンの有効/無効制御

- **admin.js**: 統一的なaction実行システム
  - `executeAction()`: 全ボタンの共通処理
  - `updateButtonStates()`: リアルタイムボタン制御
  - `loadAvailableActions()`: サーバーから利用可能アクション取得

#### フロントエンド（スクリーン表示）
- **screen.js**: 新画面表示システム
  - 5つの新しい画面状態に対応（タイトル表示、チーム発表、回答状況表示、回答発表、クラッカー演出）
  - 動的DOM生成による柔軟な画面構成
  - WebSocketメッセージ拡張（8種類の新メッセージタイプ）

- **screen.css**: 各画面専用スタイル追加
  - タイトル画面: 4rem見出し + グローアニメーション
  - チーム発表画面: グリッドレイアウト + スライドインアニメーション
  - 回答発表: 正解選択肢の強調表示 + パルスアニメーション

### 新機能

#### 1. タイトル表示機能
- 設定ファイルのイベントタイトルを大画面表示
- 「🎉 クイズ大会へようこそ！」メッセージ
- フェードイン + グローエフェクト

#### 2. 段階的チーム分け
- 管理者の明示的操作でチーム分け実行
- スクリーン画面に美しいチーム発表表示
- メンバー名をカード形式で表示

#### 3. 回答状況表示
- 参加者数・回答者数・正解者数・正解率を表示
- プログレスバー付き視覚化
- 管理者の任意のタイミングで表示可能

#### 4. 回答発表機能
- 正解選択肢のハイライト表示
- アニメーション付き強調エフェクト
- 1ベース/0ベースindex変換の適切な処理

#### 5. クラッカー演出システム
- 左右のクラッカーアイコン表示
- 50個/サイドの紙吹雪アニメーション
- 5秒間の自動クリーンアップ
- 物理演算風の落下エフェクト

### 技術的改善点（2025/9/2追加）

#### バグ修正
- **JSONパースエラー修正**: ゴルーチン内での不適切なHTTPレスポンス送信を修正
- **状態遷移エラー修正**: 自動遷移後の重複状態遷移エラーを回避
- **エラーハンドリング改善**: 非同期処理でのエラー処理を適切に実装

#### パフォーマンス最適化
- **メモリリーク防止**: クラッカーアニメーションの自動クリーンアップ（5秒）
- **DOM操作最適化**: 動的画面生成とキャッシュ機能
- **WebSocket効率化**: スクリーン専用メッセージ配信

### UI/UX改善
- **段階的進行**: 管理者が各段階を明示的に制御
- **視覚的フィードバック**: 各状態に応じた美しい画面遷移
- **誤操作防止**: 状態管理による適切なボタン制御
- **リアルタイム更新**: 利用可能アクションの自動更新
- **保守性**: 状態遷移ロジックの一元管理

### 🎯 実装ステータス
```
✅ 完全実装完了 - 2025/9/2
- 11段階の状態遷移システム
- 9つの管理者制御ボタン
- 5つのスクリーン表示画面（タイトル、チーム発表、回答状況、回答発表、クラッカー演出）
- WebSocket連携とリアルタイム更新
- エラーハンドリングとバグ修正
- アニメーション効果とUI/UX向上
```

## セッション破棄機能 ✅ 実装完了（2025/8/30）

### 機能概要
ユーザーが自分のセッション（回答履歴）を破棄し、再度参加登録できる機能を実装。誤操作を防ぐため、確認ダイアログと控えめなUI設計を採用。

### 実装詳細
- **フロントエンド**:
  - 画面右上に小さな「リセット」ボタンを配置（半透明、枠外）
  - 確認モーダル：「これまでの回答状況が消去されます。本当に破棄しますか？」
  - セッション破棄後は参加登録画面に自動遷移

- **バックエンド**:
  - `/api/reset-session` APIエンドポイント追加
  - データベースから関連データを完全削除（回答、絵文字リアクション、ユーザー情報）
  - WebSocketでの管理画面・スクリーン表示への通知（`user_left`メッセージ）
  - ログ出力機能（`LogUserSessionReset`）

### UI/UX設計
- **誤操作防止**: 画面右上固定位置、小サイズ（11px フォント）、半透明
- **確認プロセス**: 2段階確認（ボタンクリック → モーダル確認）
- **視覚的フィードバック**: 危険色（赤）での警告表示

## 5秒カウントダウンシステム ✅ 実装完了（2025/8/31）

### 機能概要
管理者が「⏰ 残り5秒アラート」ボタンを押すことで、スクリーン表示画面に視覚的なカウントダウンを表示し、回答時間の終了を効果的に演出する機能。

### 実装詳細

#### バックエンド
- **handlers/handlers.go**: `AdminAlert`エンドポイントを更新
  - `time_alert`から`countdown`メッセージシステムに変更
  - `startCountdown()`関数で5秒から1秒まで順次配信
  - スクリーン専用配信（`BroadcastToType`使用）
  - カウントダウン終了後に全クライアントに`question_end`送信

#### フロントエンド（スクリーン表示）
- **screen.html**:
  - 大きな数字表示エリア（`countdown-number-display`）
  - 全画面「終了！」表示エリア（`time-up-display`）
  - 画面端の強調枠エリア（`countdown-border`）

- **screen.css**:
  - カウントダウン数字: 12rem（モバイル8rem）、パルスアニメーション
  - 赤いグラデーション枠: 画面端20px幅、パルス効果付き
  - 「終了！」表示: 全画面背景、10rem文字サイズ

- **screen.js**:
  - `showCountdown()`: 5-1秒の数字と赤枠を同時表示
  - `showTimeUp()`: 3秒間の全画面「終了！」表示
  - `hideCountdown()`: カウントダウン要素の非表示処理

#### フロントエンド（参加者画面）
- **participant.js**: `countdown`メッセージ処理を削除
- 参加者画面では一切の表示を行わない（要求仕様通り）

### 動作フロー
1. 管理者が「⏰ 残り5秒アラート」ボタンをクリック
2. サーバーがゴルーチンで5秒カウントダウンを開始
3. スクリーン画面のみに1秒間隔で数字表示（5→4→3→2→1）
4. カウントダウン中は画面端に赤いグラデーション枠を表示
5. カウントダウン終了後、全画面に「終了！」を3秒間表示
6. 全クライアントに`question_end`送信で回答受付を停止

### UI/UX設計
- **視覚的インパクト**: 大きな数字（12rem）とパルスアニメーション
- **画面強調**: 赤いグラデーション枠による緊迫感演出
- **情報階層**: スクリーンのみ表示、参加者は回答に集中
- **時間管理**: 正確な1秒間隔での数字更新

## 管理者用ステートジャンプ機能 ✅ 実装完了（2025/9/3）

### 機能概要
管理者が任意のタイミングで任意のステートに直接ジャンプできるデバッグ機能を実装。問題番号の同時変更も可能で、画面の完全同期も実現。開発・テスト・デモ用途で強力なツールとして活用可能。

### 実装詳細

#### バックエンド実装
- **JumpStateRequest構造体**: `state`（必須）と`question_number`（オプション）を受け取る
- **AdminJumpState API**: `/api/admin/jump-state` - 任意のステートへの直接ジャンプ
- **GetAvailableStates API**: `/api/admin/available-states` - 選択可能なステート一覧を日本語ラベル付きで提供
- **JumpToState機能**: EventStateManagerに遷移制限なしのジャンプ機能を追加
- **SetCurrentQuestion機能**: 問題番号の同時変更をサポート
- **問題データ同期**: 問題番号指定時は問題内容も自動で設定・配信

#### フロントエンド実装（管理者画面）
- **デバッグセクション配置**: イベント状況下に目立たない小さなデバッグUI
- **ドロップダウン選択**: 11種類のステートを日本語表示（「参加者待ち」「問題表示中」等）
- **問題番号入力フィールド**: 0-20の範囲で問題番号を同時変更可能
- **確認ダイアログ**: ⚠️警告メッセージ付きで誤操作防止
- **現在ステート表示**: リアルタイムで現在のステートを日本語表示
- **エラーハンドリング**: 不正な値や状態遷移のエラーメッセージ表示

#### 全画面同期システム
- **WebSocket配信**: ステートジャンプ時に全クライアント（管理者・スクリーン・参加者）に`state_changed`メッセージを配信
- **スクリーン同期**: 11種類のステートに応じて適切な画面表示に自動遷移
- **参加者同期**: ステートに応じた画面制御（待機・問題表示・回答ブロック等）
- **問題データ連携**: 問題番号が指定された場合は問題内容も含めて配信・表示

### 利用可能なステート
1. **waiting**: 参加者待ち
2. **started**: イベント開始  
3. **title_display**: タイトル表示
4. **team_assignment**: チーム分け
5. **question_active**: 問題表示中
6. **countdown_active**: カウントダウン中
7. **answer_stats**: 回答状況表示
8. **answer_reveal**: 回答発表
9. **results**: 結果発表
10. **celebration**: お疲れ様画面
11. **finished**: 終了

### 安全性と使いやすさ
✅ **確認ダイアログ**: 「⚠️ これはデバッグ機能です。予期しない動作が発生する可能性があります。」  
✅ **目立たない配置**: 小さなフォント（10px-12px）でデバッグ用として配置  
✅ **MAC認証**: 管理者認証により安全にアクセス制御  
✅ **エラーハンドリング**: 不正な値や状態遷移の適切なエラー処理  
✅ **ログ記録**: 管理者のジャンプ操作をすべてログに記録  
✅ **リアルタイム同期**: 全画面が瞬時に同期して遷移  

### 使用方法
1. 管理者ページのイベント状況セクション下の「🔧 デバッグ: ステートジャンプ」
2. ドロップダウンから目的のステートを選択
3. 必要に応じて問題番号（0-20）を入力
4. 「ジャンプ」ボタンをクリック
5. 確認ダイアログで「OK」を選択
6. 全画面（管理者・スクリーン・参加者）が瞬時に同期して遷移

### 活用シーン
- **開発・テスト**: 特定の状態での動作確認
- **デモ・プレゼン**: 任意の場面を瞬時に再現
- **トラブル対応**: 問題発生時の状態復旧
- **機能確認**: 各ステートの表示・動作検証

### 🎯 実装ステータス
```
✅ 完全実装完了 - 2025/9/3
- 11種類のステート直接ジャンプ
- 問題番号の同時変更機能
- 全画面リアルタイム同期（管理者・スクリーン・参加者）
- 確認ダイアログとエラーハンドリング
- 日本語UI対応とログ記録
- デバッグ用途に最適化された安全設計
```

# 🔧 システムリファクタリング完了 ✅ 実装完了（2025/9/6）

## リファクタリング概要
複雑化したコンポーネント構成をシンプルな構成に変更し、保守性と可読性を向上。4段階のリファクタリングプロセスを経て、最終的にシンプルで直接的なDOM操作パターンに統一。

## 最終アーキテクチャ
### フロントエンド構成
- **admin.html**: 全UI要素を事前定義、統一感あるID命名規則
- **admin.js**: 直接的なDOM操作、シンプルなイベントハンドリング
- **共通ライブラリ**: constants.js, utils.js, state_manager.js, websocket_client.js

### 管理者画面UI仕様
#### 制御ボタン（統一ID命名）
- `btn-start-event`: 🚀 イベント開始
- `btn-show-title`: 📺 タイトル表示
- `btn-assign-teams`: 👥 チーム分け
- `btn-next-question`: ❓ 次の問題
- `btn-countdown-alert`: ⏰ 残り5秒アラート
- `btn-show-answer-stats`: 📊 回答状況表示
- `btn-reveal-answer`: ✅ 回答発表
- `btn-show-results`: 🏆 結果発表
- `btn-celebration`: 🎉 発表

#### 状態表示要素（統一ID命名）
- `event-status`: イベント状態表示
- `current-question`: 現在問題番号
- `participant-count`: 参加者数（複数箇所）
- `connection-status-display`: 接続状況表示

#### ログシステム仕様 ✅ **新実装（2025/9/6）**
- **固定サイズコンテナ**: 300px固定高さ、スクロール対応
- **逆順表示**: 新しいログが常に上部に表示（`flex-direction: column-reverse`）
- **自動スクロール**: 新規ログ追加時に最新ログにフォーカス（`scrollTop = 0`）
- **カラーコーディング**: タイプ別色分け（info: 青、success: 緑、warning: オレンジ、error: 赤）
- **パフォーマンス**: 最大100件制限、古いログ自動削除
- **視覚的改善**: ボーダー、背景色、タイムスタンプでログエントリを見やすく
- **実装場所**: admin.htmlの`log-container`、admin.jsの`addLog()`メソッド

### リファクタリング成果
✅ **コード簡素化**: 複雑なコンポーネント層を削除  
✅ **保守性向上**: HTML要素IDの統一命名規則（`btn-*`、`*-display`等）  
✅ **可読性向上**: 直接的なDOM操作で理解しやすい構成  
✅ **パフォーマンス**: 不要な抽象化レイヤー削除  
✅ **UI/UX向上**: ログシステムの大幅改善  

### 削除されたコンポーネント
- `static/js/components/admin_ui.js`: UIコンポーネントレイヤーを削除し、admin.jsに統合

### アーキテクチャ変更履歴
```
Phase 1: 共通定数・ユーティリティ抽出 ✅
Phase 2: バックエンド責任分離 ✅  
Phase 3: フロントエンドコンポーネント化 ✅
Phase 4: エラーハンドリング・検証強化 ✅
最終: コンポーネント削除・シンプル化 ✅
```

# important-instruction-reminders
Do what has been asked; nothing more, nothing less.
NEVER create files unless they're absolutely necessary for achieving your goal.
ALWAYS prefer editing an existing file to creating a new one.
NEVER proactively create documentation files (*.md) or README files. Only create documentation files if explicitly requested by the User.