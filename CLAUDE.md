# CLAUDE - 宴会クイズサービス要件定義書

## 1. プロジェクト概要

大人数での宴会で使用するリアルタイムクイズシステム。単一サーバーで管理者とユーザーが同時にアクセスし、WebSocketを通じてリアルタイムでクイズイベントを進行する。

## 2. システム構成

### 2.1 技術スタック
- **バックエンド**: Go言語
- **データベース**: SQLite
- **フロントエンド**: HTML/CSS/JavaScript（静的配信）
- **リアルタイム通信**: WebSocket
- **設定ファイル**: TOML形式

### 2.2 アーキテクチャ
```
[管理PC] ──┐
           ├── HTTP/WebSocket ──[Goサーバー]── SQLite
[スマホ] ──┘                     │
                                静的ファイル配信
```

## 3. 機能要件

### 3.1 基本機能

#### 3.1.1 クイズ管理
- TOML設定ファイルからクイズデータを読み込み
- 同時実行可能なクイズイベントは1つのみ
- 選択式問題のみサポート
- 正答は設定ファイルに事前定義し、自動採点

#### 3.1.2 管理機能
- 管理者専用ページからのクイズイベント制御
- イベントの開始/停止/問題遷移操作
- 参加者状況のリアルタイム監視
- 結果表示とログ出力
- 管理者用ページにアクセスできるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)
- 同様に管理者用APIを叩けるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)

#### 3.1.3 参加者機能
- スマートフォンブラウザからの参加
- ニックネーム登録
- Cookieによるセッション管理 (一度切断されても同じユーザーで再接続可能)
- セッション破棄機能（確認ダイアログ付き、誤操作防止UI）
- 問題表示と回答選択
- リアルタイム結果表示
- 絵文字ボタンがあり、押すとスクリーン表示用画面に表示される

#### 3.1.4 スクリーン表示用画面
- 参加者全員が見えるディスプレイに表示することを目的としたページ
- 現在の問題、選択肢、ステータス (何問目、回答受付中かどうか)、絵文字リアクションなどが表示される
- 最終結果や、チーム分けの結果もこの画面に表示される
- スクリーン表示用ページにアクセスできるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)
- 同様にスクリーン表示用APIを叩けるのは環境変数QUIZ_ADMIN_MAC_ADDRに設定されたMACアドレスの機器のみ (複数登録可能)

### 3.2 チーム戦モード（オプション）

#### 3.2.1 チーム分け機能
- 設定ファイルでチーム戦モード有効化
- 同グループ回避名称リストの事前設定
- 名称マッチングによる同チーム配置回避アルゴリズム
- 全参加者エントリー完了後の自動チーム分け実行

#### 3.2.2 チーム戦進行
- チーム単位での得点管理
- チーム結果の表示

## 4. 設定ファイル仕様

### 4.1 TOML設定ファイル構造
```toml
[event]
title = "新年会クイズ大会"
team_mode = true
team_size = 5 #チームの最大人数

[team_separation]
avoid_groups = ["田中", "山田", "やまだ", "ヤマダ"]

[[questions]]
type = "text"
text = "Goの作者は誰ですか？"
image = "go_auther.png"
choices = ["Rob Pike", "Linus Torvalds", "Dennis Ritchie", "Ken Thompson"]
correct = 0

[[questions]]
type = "text"
text = "HTTPSのデフォルトポートは？"
choices = ["80", "443", "8080", "3000"]
correct = 1

[[questions]]
type = "image"
text = "IEEEのロゴマークは？"
choices = ["wrong_logo.png", "ieee_logo.png", "bad_logo.png"]
correct = 1
```

## 5. 非機能要件

### 5.1 性能要件
- **同時接続数**: 最大100人
- **応答時間**: WebSocket通信での即座な状態更新
- **可用性**: イベント中の安定した接続維持

### 5.2 運用要件
- **ログ出力**: イベント進行ログをテキストファイルに記録
- **データ保持**: イベント終了後のデータベース保持（履歴機能は不要）
- **設定変更**: サーバー再起動による設定ファイル再読み込み

## 6. システムフロー

### 6.1 個人戦モードフロー
1. 管理者がクイズイベント開始
2. 参加者がニックネーム登録
3. 管理者が問題を順次出題
4. 参加者が制限時間内に回答
5. リアルタイムで結果表示
6. 最終順位発表

### 6.2 チーム戦モードフロー
1. 管理者がチーム戦イベント開始
2. 参加者がニックネーム登録
3. 全員エントリー完了後、自動チーム分け実行
4. チーム発表
5. 管理者が問題を順次出題
6. 参加者が個別に回答（チーム得点に反映）
7. チーム順位発表

## 7. API設計

### 7.1 HTTP エンドポイント
- `GET /` - 参加者用ページ
- `POST /api/join` - 参加者登録
- `POST /api/answer` - 回答送信
- `POST /api/reset-session` - セッション破棄
- `GET /admin` - 管理者用ページ
- `POST /api/admin/start` - イベント開始
- `POST /api/admin/next` - 次の問題へ
- `POST /api/admin/stop` - イベント終了
- `GET /show` - スクリーン表示用画面ページ

### 7.2 WebSocket メッセージ
- `user_joined` - 参加者参加通知
- `user_left` - 参加者離脱通知（セッション破棄時）
- `question_start` - 問題開始
- `question_end` - 回答締切
- `results` - 結果表示
- `team_assignment` - チーム分け結果
- `final_results` - 最終結果
- `emoji` - 絵文字リアクション

## 8. データベース設計

### 8.1 テーブル構成
- **users** - 参加者情報
- **teams** - チーム情報（チーム戦時）
- **answers** - 回答履歴
- **events** - イベント情報

## 9. セキュリティ要件

- 参加者の重複参加防止
- 不正回答の防止（問題IDと回答タイムスタンプの検証）

## 10. 制約事項

- 単一サーバー・単一イベント制限
- ネットワーク環境に依存するリアルタイム性
- ブラウザ互換性（主要モバイルブラウザ対応）

# 🆕 最新実装機能

## セッション破棄機能 ✅ 実装完了（2025/8/30）

### 機能概要
ユーザーが自分のセッション（回答履歴）を破棄し、再度参加登録できる機能を実装。誤操作を防ぐため、確認ダイアログと控えめなUI設計を採用。

### 実装詳細
- **フロントエンド**:
  - 画面右上に小さな「リセット」ボタンを配置（半透明、枠外）
  - 確認モーダル：「これまでの回答状況が消去されます。本当に破棄しますか？」
  - セッション破棄後は参加登録画面に自動遷移

- **バックエンド**:
  - `/api/reset-session` APIエンドポイント追加
  - データベースから関連データを完全削除（回答、絵文字リアクション、ユーザー情報）
  - WebSocketでの管理画面・スクリーン表示への通知（`user_left`メッセージ）
  - ログ出力機能（`LogUserSessionReset`）

### UI/UX設計
- **誤操作防止**: 画面右上固定位置、小サイズ（11px フォント）、半透明
- **確認プロセス**: 2段階確認（ボタンクリック → モーダル確認）
- **視覚的フィードバック**: 危険色（赤）での警告表示

## 5秒カウントダウンシステム ✅ 実装完了（2025/8/31）

### 機能概要
管理者が「⏰ 残り5秒アラート」ボタンを押すことで、スクリーン表示画面に視覚的なカウントダウンを表示し、回答時間の終了を効果的に演出する機能。

### 実装詳細

#### バックエンド
- **handlers/handlers.go**: `AdminAlert`エンドポイントを更新
  - `time_alert`から`countdown`メッセージシステムに変更
  - `startCountdown()`関数で5秒から1秒まで順次配信
  - スクリーン専用配信（`BroadcastToType`使用）
  - カウントダウン終了後に全クライアントに`question_end`送信

#### フロントエンド（スクリーン表示）
- **screen.html**:
  - 大きな数字表示エリア（`countdown-number-display`）
  - 全画面「終了！」表示エリア（`time-up-display`）
  - 画面端の強調枠エリア（`countdown-border`）

- **screen.css**:
  - カウントダウン数字: 12rem（モバイル8rem）、パルスアニメーション
  - 赤いグラデーション枠: 画面端20px幅、パルス効果付き
  - 「終了！」表示: 全画面背景、10rem文字サイズ

- **screen.js**:
  - `showCountdown()`: 5-1秒の数字と赤枠を同時表示
  - `showTimeUp()`: 3秒間の全画面「終了！」表示
  - `hideCountdown()`: カウントダウン要素の非表示処理

#### フロントエンド（参加者画面）
- **participant.js**: `countdown`メッセージ処理を削除
- 参加者画面では一切の表示を行わない（要求仕様通り）

### 動作フロー
1. 管理者が「⏰ 残り5秒アラート」ボタンをクリック
2. サーバーがゴルーチンで5秒カウントダウンを開始
3. スクリーン画面のみに1秒間隔で数字表示（5→4→3→2→1）
4. カウントダウン中は画面端に赤いグラデーション枠を表示
5. カウントダウン終了後、全画面に「終了！」を3秒間表示
6. 全クライアントに`question_end`送信で回答受付を停止

### UI/UX設計
- **視覚的インパクト**: 大きな数字（12rem）とパルスアニメーション
- **画面強調**: 赤いグラデーション枠による緊迫感演出
- **情報階層**: スクリーンのみ表示、参加者は回答に集中
- **時間管理**: 正確な1秒間隔での数字更新

# important-instruction-reminders
Do what has been asked; nothing more, nothing less.
NEVER create files unless they're absolutely necessary for achieving your goal.
ALWAYS prefer editing an existing file to creating a new one.
NEVER proactively create documentation files (*.md) or README files. Only create documentation files if explicitly requested by the User.
